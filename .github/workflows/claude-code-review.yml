name: Claude Code Review

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
    # Focus on Swift/SwiftUI code changes
    paths:
      - "**/*.swift"
      - "**/*.yml"
      - "**/*.yaml"
      - "Scripts/**"
      - ".github/workflows/**"

# Separate concurrency group for reviews to avoid conflicts with testing pipeline
concurrency:
  group: claude-review-${{ github.ref }}
  cancel-in-progress: true

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip review for certain conditions
    if: |
      !contains(github.event.pull_request.title, '[skip-review]') &&
      !contains(github.event.pull_request.title, '[WIP]') &&
      !contains(github.event.pull_request.title, 'WIP:')
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch more history for better context
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          secrets_admin_pat: ${{ secrets.SECRETS_ADMIN_PAT }}
          
          # Swift/SwiftUI specific review prompt
          prompt: |
            You are conducting a comprehensive code review for a SwiftUI travel planning app called "Traveling Snails". 
            This app uses SwiftData + CloudKit for data persistence and follows modern iOS 18+ patterns.
            
            üîç **CRITICAL ANALYSIS AREAS:**
            
            üîí **SECURITY REVIEW:**
            - Hardcoded secrets, API keys, or sensitive data exposure
            - Input validation and sanitization
            - Secure data handling patterns
            - Logger usage instead of print() statements
            - CloudKit data privacy considerations
            
            üêõ **SWIFTUI/SWIFTDATA BUG DETECTION:**
            - SwiftData infinite recreation anti-patterns (passing model arrays as view parameters)
            - Improper @State/@Observable/@Query usage
            - NavigationView usage (should be NavigationStack)
            - Memory leaks and retain cycles
            - Threading issues with @MainActor
            - CloudKit sync compatibility issues
            
            üì± **MODERN SWIFT PATTERNS:**
            - iOS 18+ SwiftUI patterns compliance
            - Swift Testing instead of XCTest usage
            - Proper async/await and structured concurrency
            - SwiftData relationship patterns
            - Error handling with Result types
            
            üèóÔ∏è **ARCHITECTURE & PATTERNS:**
            - MVVM adherence and dependency injection
            - Service layer organization
            - Protocol usage and testability
            - Separation of concerns
            
            ‚ö° **PERFORMANCE:**
            - Main thread blocking operations
            - Inefficient SwiftData queries
            - View update optimizations
            - CloudKit sync performance
            
            üß™ **TEST COVERAGE:**
            - Missing test scenarios
            - Test isolation and SwiftDataTestBase usage
            - Mock service integration
            
            üìã **OUTPUT FORMAT:**
            Please structure your review as:
            1. **Overall Assessment** (1-2 sentences)
            2. **Critical Issues** (‚ùå Must fix before merge)
            3. **Recommendations** (‚ö†Ô∏è Should consider)
            4. **Positive Observations** (‚úÖ Good patterns)
            5. **File-Specific Notes** (with file:line references)
            
            Be thorough, constructive, and specific. Focus on preventing the SwiftData infinite recreation bug and ensuring modern Swift patterns.

